# embedding
[优秀博客](https://zhuanlan.zhihu.com/p/695785781?utm_psn=1770477175637983233)


## 0x00 说明

包含以下内容：

- [X] embedding_f32_kernel
- [X] embedding_f32x4_kernel(float4向量化版本)
- [X] embedding_f32x4_pack_kernel(float4向量化，pack版本版本)
- [X] embedding_f16_kernel(fp16版本)
- [X] embedding_f16x8_kernel(fp16向量化版本)
- [X] embedding_f16x8_pack_kernel(fp16向量化，pack版本)
- [X] PyTorch bindings


## 测试

```bash
# 只测试Ada架构 不指定默认编译所有架构 耗时较长: Volta, Ampere, Ada, Hopper, ...
export TORCH_CUDA_ARCH_LIST=Ada 
python3 embedding.py
```
一个elemwise的操作，但是有个值得探究的问题，在f16下pack的性能优于没有pack的性能但是在f32下相反
输出:

```bash
--------------------------------------------------------------------------------------------------------------
                                             MaxV=1024, SeqLen=2048, EmbSize=512
                out_f32: ['0.69075936  ', '0.56517494  ', '-0.12546943 '], time:0.005317ms
              out_f32x4: ['0.69075936  ', '0.56517494  ', '-0.12546943 '], time:0.004125ms
         out_f32x4_pack: ['0.69075936  ', '0.56517494  ', '-0.12546943 '], time:0.004017ms
             out_f32_th: ['0.69075936  ', '0.56517494  ', '-0.12546943 '], time:0.012147ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['-1.27734375 ', '-0.92822266 ', '-1.4453125  '], time:0.005090ms
              out_f16x8: ['-1.27734375 ', '-0.92822266 ', '-1.4453125  '], time:0.004089ms
         out_f16x8_pack: ['-1.27734375 ', '-0.92822266 ', '-1.4453125  '], time:0.004041ms
             out_f16_th: ['-1.27734375 ', '-0.92822266 ', '-1.4453125  '], time:0.011230ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=1024, SeqLen=2048, EmbSize=1024
                out_f32: ['-1.34922504 ', '-0.04674992 ', '1.24448562  '], time:0.011468ms
              out_f32x4: ['-1.34922504 ', '-0.04674992 ', '1.24448562  '], time:0.005364ms
         out_f32x4_pack: ['-1.34922504 ', '-0.04674992 ', '1.24448562  '], time:0.005448ms
             out_f32_th: ['-1.34922504 ', '-0.04674992 ', '1.24448562  '], time:0.037062ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['-0.47412109 ', '-0.47070312 ', '1.41894531  '], time:0.011039ms
              out_f16x8: ['-0.47412109 ', '-0.47070312 ', '1.41894531  '], time:0.004971ms
         out_f16x8_pack: ['-0.47412109 ', '-0.47070312 ', '1.41894531  '], time:0.004065ms
             out_f16_th: ['-0.47412109 ', '-0.47070312 ', '1.41894531  '], time:0.016463ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=1024, SeqLen=4096, EmbSize=512
                out_f32: ['0.30875409  ', '0.98055625  ', '-0.86661887 '], time:0.008464ms
              out_f32x4: ['0.30875409  ', '0.98055625  ', '-0.86661887 '], time:0.005400ms
         out_f32x4_pack: ['0.30875409  ', '0.98055625  ', '-0.86661887 '], time:0.005484ms
             out_f32_th: ['0.30875409  ', '0.98055625  ', '-0.86661887 '], time:0.016463ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['-1.04492188 ', '0.44750977  ', '-1.25878906 '], time:0.008070ms
              out_f16x8: ['-1.04492188 ', '0.44750977  ', '-1.25878906 '], time:0.005186ms
         out_f16x8_pack: ['-1.04492188 ', '0.44750977  ', '-1.25878906 '], time:0.004339ms
             out_f16_th: ['-1.04492188 ', '0.44750977  ', '-1.25878906 '], time:0.016415ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=1024, SeqLen=4096, EmbSize=1024
                out_f32: ['-0.07979927 ', '-0.20634571 ', '0.9166832   '], time:0.021017ms
              out_f32x4: ['-0.07979927 ', '-0.20634571 ', '0.9166832   '], time:0.008297ms
         out_f32x4_pack: ['-0.07979927 ', '-0.20634571 ', '0.9166832   '], time:0.008714ms
             out_f32_th: ['-0.07979927 ', '-0.20634571 ', '0.9166832   '], time:0.037730ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['-2.19726562 ', '0.50439453  ', '1.40917969  '], time:0.020158ms
              out_f16x8: ['-2.19726562 ', '0.50439453  ', '1.40917969  '], time:0.007451ms
         out_f16x8_pack: ['-2.19726562 ', '0.50439453  ', '1.40917969  '], time:0.005496ms
             out_f16_th: ['-2.19726562 ', '0.50439453  ', '1.40917969  '], time:0.030172ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=4096, SeqLen=2048, EmbSize=512
                out_f32: ['-0.13596091 ', '-0.07996719 ', '-2.77454519 '], time:0.005329ms
              out_f32x4: ['-0.13596091 ', '-0.07996719 ', '-2.77454519 '], time:0.004041ms
         out_f32x4_pack: ['-0.13596091 ', '-0.07996719 ', '-2.77454519 '], time:0.004005ms
             out_f32_th: ['-0.13596091 ', '-0.07996719 ', '-2.77454519 '], time:0.011110ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['0.14440918  ', '0.26367188  ', '0.77539062  '], time:0.005066ms
              out_f16x8: ['0.14440918  ', '0.26367188  ', '0.77539062  '], time:0.004041ms
         out_f16x8_pack: ['0.14440918  ', '0.26367188  ', '0.77539062  '], time:0.003982ms
             out_f16_th: ['0.14440918  ', '0.26367188  ', '0.77539062  '], time:0.011170ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=4096, SeqLen=2048, EmbSize=1024
                out_f32: ['1.26920044  ', '0.12124556  ', '0.38764721  '], time:0.011575ms
              out_f32x4: ['1.26920044  ', '0.12124556  ', '0.38764721  '], time:0.005329ms
         out_f32x4_pack: ['1.26920044  ', '0.12124556  ', '0.38764721  '], time:0.005519ms
             out_f32_th: ['1.26920044  ', '0.12124556  ', '0.38764721  '], time:0.016499ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['0.49243164  ', '-0.44116211 ', '-0.14611816 '], time:0.011182ms
              out_f16x8: ['0.49243164  ', '-0.44116211 ', '-0.14611816 '], time:0.004947ms
         out_f16x8_pack: ['0.49243164  ', '-0.44116211 ', '-0.14611816 '], time:0.004029ms
             out_f16_th: ['0.49243164  ', '-0.44116211 ', '-0.14611816 '], time:0.016606ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=4096, SeqLen=4096, EmbSize=512
                out_f32: ['-1.29970169 ', '-1.45127702 ', '-0.7259807  '], time:0.008452ms
              out_f32x4: ['-1.29970169 ', '-1.45127702 ', '-0.7259807  '], time:0.005424ms
         out_f32x4_pack: ['-1.29970169 ', '-1.45127702 ', '-0.7259807  '], time:0.005460ms
             out_f32_th: ['-1.29970169 ', '-1.45127702 ', '-0.7259807  '], time:0.016463ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['0.88623047  ', '0.00491714  ', '0.38525391  '], time:0.008094ms
              out_f16x8: ['0.88623047  ', '0.00491714  ', '0.38525391  '], time:0.005186ms
         out_f16x8_pack: ['0.88623047  ', '0.00491714  ', '0.38525391  '], time:0.004339ms
             out_f16_th: ['0.88623047  ', '0.00491714  ', '0.38525391  '], time:0.016451ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=4096, SeqLen=4096, EmbSize=1024
                out_f32: ['0.62899369  ', '0.55146962  ', '-0.03596229 '], time:0.021005ms
              out_f32x4: ['0.62899369  ', '0.55146962  ', '-0.03596229 '], time:0.008404ms
         out_f32x4_pack: ['0.62899369  ', '0.55146962  ', '-0.03596229 '], time:0.008738ms
             out_f32_th: ['0.62899369  ', '0.55146962  ', '-0.03596229 '], time:0.056100ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['1.13085938  ', '1.19628906  ', '-0.61035156 '], time:0.020254ms
              out_f16x8: ['1.13085938  ', '1.19628906  ', '-0.61035156 '], time:0.007451ms
         out_f16x8_pack: ['1.13085938  ', '1.19628906  ', '-0.61035156 '], time:0.005472ms
             out_f16_th: ['1.13085938  ', '1.19628906  ', '-0.61035156 '], time:0.030160ms
--------------------------------------------------------------------------------------------------------------
```

A100:

```
--------------------------------------------------------------------------------------------------------------
                                             MaxV=1024, SeqLen=2048, EmbSize=512
                out_f32: ['-0.45168209 ', '0.29194009  ', '0.82584304  '], time:0.009465ms
              out_f32x4: ['-0.45168209 ', '0.29194009  ', '0.82584304  '], time:0.015581ms
         out_f32x4_pack: ['-0.45168209 ', '0.29194009  ', '0.82584304  '], time:0.006628ms
             out_f32_th: ['-0.45168209 ', '0.29194009  ', '0.82584304  '], time:0.017822ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['1.00390625  ', '-0.35180664 ', '-0.52490234 '], time:0.007582ms
              out_f16x8: ['1.00390625  ', '-0.35180664 ', '-0.52490234 '], time:0.016963ms
         out_f16x8_pack: ['1.00390625  ', '-0.35180664 ', '-0.52490234 '], time:0.005925ms
             out_f16_th: ['1.00390625  ', '-0.35180664 ', '-0.52490234 '], time:0.017488ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=1024, SeqLen=2048, EmbSize=1024
                out_f32: ['-1.61587405 ', '-0.03222437 ', '0.2337966   '], time:0.012028ms
              out_f32x4: ['-1.61587405 ', '-0.03222437 ', '0.2337966   '], time:0.024664ms
         out_f32x4_pack: ['-1.61587405 ', '-0.03222437 ', '0.2337966   '], time:0.008869ms
             out_f32_th: ['-1.61587405 ', '-0.03222437 ', '0.2337966   '], time:0.054944ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['1.32714844  ', '1.2734375   ', '0.21728516  '], time:0.011480ms
              out_f16x8: ['1.32714844  ', '1.2734375   ', '0.21728516  '], time:0.027311ms
         out_f16x8_pack: ['1.32714844  ', '1.2734375   ', '0.21728516  '], time:0.006676ms
             out_f16_th: ['1.32714844  ', '1.2734375   ', '0.21728516  '], time:0.030243ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=1024, SeqLen=4096, EmbSize=512
                out_f32: ['-1.06653297 ', '-0.46463117 ', '0.92204446  '], time:0.011730ms
              out_f32x4: ['-1.06653297 ', '-0.46463117 ', '0.92204446  '], time:0.026035ms
         out_f32x4_pack: ['-1.06653297 ', '-0.46463117 ', '0.92204446  '], time:0.009012ms
             out_f32_th: ['-1.06653297 ', '-0.46463117 ', '0.92204446  '], time:0.030041ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['1.5546875   ', '-0.5546875  ', '-1.109375   '], time:0.011134ms
              out_f16x8: ['1.5546875   ', '-0.5546875  ', '-1.109375   '], time:0.027955ms
         out_f16x8_pack: ['1.5546875   ', '-0.5546875  ', '-1.109375   '], time:0.007844ms
             out_f16_th: ['1.5546875   ', '-0.5546875  ', '-1.109375   '], time:0.030029ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=1024, SeqLen=4096, EmbSize=1024
                out_f32: ['0.50681871  ', '0.61079907  ', '-0.98067886 '], time:0.019789ms
              out_f32x4: ['0.50681871  ', '0.61079907  ', '-0.98067886 '], time:0.045264ms
         out_f32x4_pack: ['0.50681871  ', '0.61079907  ', '-0.98067886 '], time:0.013363ms
             out_f32_th: ['0.50681871  ', '0.61079907  ', '-0.98067886 '], time:0.069499ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['-0.67724609 ', '0.0838623   ', '-0.73339844 '], time:0.018847ms
              out_f16x8: ['-0.67724609 ', '0.0838623   ', '-0.73339844 '], time:0.048292ms
         out_f16x8_pack: ['-0.67724609 ', '0.0838623   ', '-0.73339844 '], time:0.009060ms
             out_f16_th: ['-0.67724609 ', '0.0838623   ', '-0.73339844 '], time:0.054586ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=4096, SeqLen=2048, EmbSize=512
                out_f32: ['-0.52657497 ', '0.73829484  ', '0.39899519  '], time:0.007999ms
              out_f32x4: ['-0.52657497 ', '0.73829484  ', '0.39899519  '], time:0.015438ms
         out_f32x4_pack: ['-0.52657497 ', '0.73829484  ', '0.39899519  '], time:0.006688ms
             out_f32_th: ['-0.52657497 ', '0.73829484  ', '0.39899519  '], time:0.017476ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['-0.14501953 ', '-0.12561035 ', '-1.25488281 '], time:0.007474ms
              out_f16x8: ['-0.14501953 ', '-0.12561035 ', '-1.25488281 '], time:0.017107ms
         out_f16x8_pack: ['-0.14501953 ', '-0.12561035 ', '-1.25488281 '], time:0.005889ms
             out_f16_th: ['-0.14501953 ', '-0.12561035 ', '-1.25488281 '], time:0.017428ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=4096, SeqLen=2048, EmbSize=1024
                out_f32: ['-0.63360232 ', '-0.62469959 ', '0.47357446  '], time:0.012028ms
              out_f32x4: ['-0.63360232 ', '-0.62469959 ', '0.47357446  '], time:0.024652ms
         out_f32x4_pack: ['-0.63360232 ', '-0.62469959 ', '0.47357446  '], time:0.008857ms
             out_f32_th: ['-0.63360232 ', '-0.62469959 ', '0.47357446  '], time:0.030446ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['-0.04663086 ', '0.05566406  ', '1.99609375  '], time:0.011516ms
              out_f16x8: ['-0.04663086 ', '0.05566406  ', '1.99609375  '], time:0.027585ms
         out_f16x8_pack: ['-0.04663086 ', '0.05566406  ', '1.99609375  '], time:0.006628ms
             out_f16_th: ['-0.04663086 ', '0.05566406  ', '1.99609375  '], time:0.030172ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=4096, SeqLen=4096, EmbSize=512
                out_f32: ['-2.61375785 ', '0.24483714  ', '-1.0284847  '], time:0.011837ms
              out_f32x4: ['-2.61375785 ', '0.24483714  ', '-1.0284847  '], time:0.026238ms
         out_f32x4_pack: ['-2.61375785 ', '0.24483714  ', '-1.0284847  '], time:0.009012ms
             out_f32_th: ['-2.61375785 ', '0.24483714  ', '-1.0284847  '], time:0.030255ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['-1.82226562 ', '0.83496094  ', '0.9375      '], time:0.011182ms
              out_f16x8: ['-1.82226562 ', '0.83496094  ', '0.9375      '], time:0.027955ms
         out_f16x8_pack: ['-1.82226562 ', '0.83496094  ', '0.9375      '], time:0.007880ms
             out_f16_th: ['-1.82226562 ', '0.83496094  ', '0.9375      '], time:0.030065ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=4096, SeqLen=4096, EmbSize=1024
                out_f32: ['0.15770201  ', '-1.60733104 ', '-1.27076626 '], time:0.028014ms
              out_f32x4: ['0.15770201  ', '-1.60733104 ', '-1.27076626 '], time:0.045168ms
         out_f32x4_pack: ['0.15770201  ', '-1.60733104 ', '-1.27076626 '], time:0.015604ms
             out_f32_th: ['0.15770201  ', '-1.60733104 ', '-1.27076626 '], time:0.096035ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['0.98046875  ', '-0.99658203 ', '1.51660156  '], time:0.018847ms
              out_f16x8: ['0.98046875  ', '-0.99658203 ', '1.51660156  '], time:0.048304ms
         out_f16x8_pack: ['0.98046875  ', '-0.99658203 ', '1.51660156  '], time:0.009084ms
             out_f16_th: ['0.98046875  ', '-0.99658203 ', '1.51660156  '], time:0.054824ms
--------------------------------------------------------------------------------------------------------------
```